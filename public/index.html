<!DOCTYPE html>
<html>

<head>
  <title>Socket.IO chat</title>
  <link rel="stylesheet" href="styles.css">
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"
    integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
</head>

<body>
  <div id="interface">
    <div id="chat">
      <ul id="messages"></ul>
      <form id="form" action="">
        <input id="input" autocomplete="off" /><button>Send</button>
      </form>
    </div>
    <div id="game">
      <div id="gamearea">
        <div class="cabecalho">
          <center>
            <div class="pl1">
              <b id="branco_pontos">0</b>
            </div>
            <div id="atualJogador" class="plcenter"></div>
            <div class="pl2">
              <b id="preto_pontos">0</b>
            </div>
            <div class="clear"></div>
          </center>
        </div>
        <table class="table">
          <tbody>
            <tr>
              <td id="tabuleiro11">
                <img onclick="verificaJogada(1,1)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro12">
                <img onclick="verificaJogada(1,2)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro13">
                <img onclick="verificaJogada(1,3)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro14">
                <img onclick="verificaJogada(1,4)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro15">
                <img onclick="verificaJogada(1,5)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro16">
                <img onclick="verificaJogada(1,6)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro17">
                <img onclick="verificaJogada(1,7)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro18">
                <img onclick="verificaJogada(1,8)" src="/images/semBolinha.gif" />
              </td>
            </tr>
            <tr>
              <td id="tabuleiro21">
                <img onclick="verificaJogada(2,1)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro22">
                <img onclick="verificaJogada(2,2)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro23">
                <img onclick="verificaJogada(2,3)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro24">
                <img onclick="verificaJogada(2,4)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro25">
                <img onclick="verificaJogada(2,5)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro26">
                <img onclick="verificaJogada(2,6)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro27">
                <img onclick="verificaJogada(2,7)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro28">
                <img onclick="verificaJogada(2,8)" src="/images/semBolinha.gif" />
              </td>
            </tr>
            <tr>
              <td id="tabuleiro31">
                <img onclick="verificaJogada(3,1)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro32">
                <img onclick="verificaJogada(3,2)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro33">
                <img onclick="verificaJogada(3,3)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro34">
                <img onclick="verificaJogada(3,4)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro35">
                <img onclick="verificaJogada(3,5)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro36">
                <img onclick="verificaJogada(3,6)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro37">
                <img onclick="verificaJogada(3,7)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro38">
                <img onclick="verificaJogada(3,8)" src="/images/semBolinha.gif" />
              </td>
            </tr>
            <tr>
              <td id="tabuleiro41">
                <img onclick="verificaJogada(4,1)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro42">
                <img onclick="verificaJogada(4,2)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro43">
                <img onclick="verificaJogada(4,3)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro44">
                <img onclick="verificaJogada(4,4)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro45">
                <img onclick="verificaJogada(4,5)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro46">
                <img onclick="verificaJogada(4,6)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro47">
                <img onclick="verificaJogada(4,7)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro48">
                <img onclick="verificaJogada(4,8)" src="/images/semBolinha.gif" />
              </td>
            </tr>
            <tr>
              <td id="tabuleiro51">
                <img onclick="verificaJogada(5,1)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro52">
                <img onclick="verificaJogada(5,2)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro53">
                <img onclick="verificaJogada(5,3)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro54">
                <img onclick="verificaJogada(5,4)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro55">
                <img onclick="verificaJogada(5,5)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro56">
                <img onclick="verificaJogada(5,6)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro57">
                <img onclick="verificaJogada(5,7)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro58">
                <img onclick="verificaJogada(5,8)" src="/images/semBolinha.gif" />
              </td>
            </tr>
            <tr>
              <td id="tabuleiro61">
                <img onclick="verificaJogada(6,1)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro62">
                <img onclick="verificaJogada(6,2)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro63">
                <img onclick="verificaJogada(6,3)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro64">
                <img onclick="verificaJogada(6,4)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro65">
                <img onclick="verificaJogada(6,5)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro66">
                <img onclick="verificaJogada(6,6)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro67">
                <img onclick="verificaJogada(6,7)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro68">
                <img onclick="verificaJogada(6,8)" src="/images/semBolinha.gif" />
              </td>
            </tr>
            <tr>
              <td id="tabuleiro71">
                <img onclick="verificaJogada(7,1)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro72">
                <img onclick="verificaJogada(7,2)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro73">
                <img onclick="verificaJogada(7,3)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro74">
                <img onclick="verificaJogada(7,4)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro75">
                <img onclick="verificaJogada(7,5)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro76">
                <img onclick="verificaJogada(7,6)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro77">
                <img onclick="verificaJogada(7,7)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro78">
                <img onclick="verificaJogada(7,8)" src="/images/semBolinha.gif" />
              </td>
            </tr>
            <tr>
              <td id="tabuleiro81">
                <img onclick="verificaJogada(8,1)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro82">
                <img onclick="verificaJogada(8,2)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro83">
                <img onclick="verificaJogada(8,3)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro84">
                <img onclick="verificaJogada(8,4)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro85">
                <img onclick="verificaJogada(8,5)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro86">
                <img onclick="verificaJogada(8,6)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro87">
                <img onclick="verificaJogada(8,7)" src="/images/semBolinha.gif" />
              </td>
              <td id="tabuleiro88">
                <img onclick="verificaJogada(8,8)" src="/images/semBolinha.gif" />
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div id="menu">
      <div id = "cor">
        <p>Com que cor você deseja jogar?</p>
        <tr>
          <td><button id = preto>Preto</button></td>
          <td><button id = branco>Branco</button></td>
        </tr>
      </div>
      <div id = "turno">
        <p>Troca de turno</p>
        <tr>
          <td><button id = troca onclick="trocarDeTurno()">trocar</button></td>
      </div>
      <div id = "turno">
        <p>Desistir da partida</p>
        <tr>
          <td><button id = troca onclick="desistirDaPartida()">Desistir?</button></td>
      </div>
    </div>
    <div id="log"></div>
  </div>

  <script>
    socket = login();
    var tabuleiro = []

    var messages = document.getElementById('messages');
    var form = document.getElementById('form');
    var input = document.getElementById('input');
    var corDoJogador = ""
    var turno = "preto"
    var clique = ""
    var brancas = 0
    var pretas = 0

    form.addEventListener('submit', function (e) {
      e.preventDefault();
      if (input.value) {
        console.log(`enviando mensagem chat message: ${input.value}`)
        socket.emit('chat message', input.value);
        input.value = '';
      }
    });

    socket.on('chat message', function (msg) {
      console.log(`recebendo chat message do servidor: ${msg}`)
      var item = document.createElement('li');
      item.textContent = msg;
      messages.appendChild(item);
      messages.scrollIntoView(true)
      document.getElementById("form").scrollIntoView(true)
    });

    socket.on("tabuleiro", (tab)=>{
      console.log(`recebeu tabuleiro`)
      tabuleiro = tab
      render(tabuleiro)
    })

    socket.on("cores disponiveis", (coresD) => {
      console.log(`verficando cores disponiveis: ${coresD}`)
      coresLength = coresD["coresDisponiveis"].length
      if (coresLength > 1 && coresD["cor"] == ""){
        document.getElementById("preto").innerHTML = "<button id = preto onclick='escolherCor(`preto`)'>Preto</button>"
        document.getElementById("branco").innerHTML = "<button id = branco onclick='escolherCor(`branco`)'>Branco</button>"
      }
      else if (coresD["cor"] == "preto"){
        console.log(`desabilita botao: ${coresD["cor"]}`)
        document.getElementById("preto").innerHTML = "<button id = preto onclick='escolherCor(`preto`)' disabled>Preto</button>"
      }
      else if(coresD["cor"] == "branco"){
        console.log(`desabilita botao: ${coresD["cor"]}`)
        document.getElementById("branco").innerHTML = "<button id = branco onclick='escolherCor(`branco`)' disabled>Branco</button>"
      }
      if (coresLength == 1){
        render(tabuleiro)
      }
    })

    socket.on("cor", cor => {
      console.log(`atribui cor do jogador: ${cor}`)
      corDoJogador = cor
      if (cor == "preto"){
        console.log(`desabilita botao: branco`)
        document.getElementById("branco").innerHTML = "<button id = branco onclick='escolherCor(`branco`)' disabled>Branco</button>"
      }else{
        console.log(`desabilita botao: preto`)
        document.getElementById("preto").innerHTML = "<button id = preto onclick='escolherCor(`preto`)' disabled>Preto</button>"
      }
    })

    socket.on("turno", newTurno => {
      console.log(`recebendo turno: ${newTurno}`)
      turno = newTurno
      render(tabuleiro)
    })

    socket.on("desistir", msg => {
      alert(msg)
      window.location.reload(true)
    })

    function login() {
      var username = prompt("Bem vindo ao jogo *****\nInsira seu apelido:", "");
      if (username == null || username == "") {
        username = "anonimo"
      }
      var socket = io();
      console.log(`username: ${username}`)
      socket.emit('login', username)
      return socket
    }

    function render(tabuleiro){
      console.log(`[funcao] render tabuleiro`)
      auxPretas = 0
      auxBrancas = 0
      for(i = 1; i <= 8; i++){
        for(j = 1; j <= 8; j++){
          // verificar turno do cara para habiitar o clique
          if (tabuleiro[i][j] == "preto"){
            auxPretas += 1
          }else if(tabuleiro[i][j] == "branco"){
            auxBrancas += 1
          }
          
          if (corDoJogador == turno && turno != ""){
            console.log(`agora você pode clicar`)
            clique = 'onclick="acaoDoBotao('+i+','+j+')"';
          }else{
            clique = ""
          }
          document.all.item("tabuleiro"+(i)+(j)).innerHTML = '<img src="/images/'+tabuleiro[i][j]+'.gif" '+clique+' width="35" height="35">';
        }
      }
      if (auxPretas + auxBrancas == 64){
        if (auxPretas > auxBrancas){
          desistirDaPartida("branco")
        }else{
          desistirDaPartida("preto")
        }
      }

      brancas = auxBrancas
      preto = auxPretas
    }

    function escolherCor(cor){
      console.log(`[funcao] escolherCor cor`)
      socket.emit("cor", cor)
    }

    function trocarDeTurno(){
      console.log(`[funcao] trocaDeTurno`)
        socket.emit("turno", turno)
    }

    function acaoDoBotao(i, j){
      console.log(`[funcao] acaoDoBotao: args(${i}, ${j})`)
      // tenho que pegar do tabuleiro e nao da div
      if (tabuleiro[i][j] == "preto"){
        tabuleiro[i][j] = "branco"
      }else if (tabuleiro[i][j] == "branco"){
        tabuleiro[i][j] = "preto"
      }else if (tabuleiro[i][j] == "semBolinha"){
        tabuleiro[i][j] = corDoJogador
      }
      socket.emit("tabuleiro", tabuleiro)
    }

    function desistirDaPartida(cor = corDoJogador){
      socket.emit("desistir", cor)
    }

  </script>
</body>

</html>